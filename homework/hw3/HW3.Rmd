---
title: "合租模式下的租房价格分析"
author: "梁之扬 19307130184"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library(kableExtra)
library(ggplot2)
library(DAAG)
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format = "html") 
```
## 数据读入与汇总统计
```{r}
df <- read.csv(file = "data.csv",fileEncoding = 'utf-8',as.is = F)
kable(summary(df))
```

## 月租金分布情况
```{r}
hist(df$rent, col = '#FFFF00', main = '北京合租房月租金', xlab = '租金（元/月）',ylab = '频数')
```

结合汇总统计以及直方图，我们可以看出，月租金在1150元以上，6460元以下，2000元至3000元的区间内分布较多，整体呈现右偏的状态，说明合租房中也可能存在“高端类型”。

## 不同城区租房平均价格
```{r}
sort(tapply(df$rent, df$region, mean), decreasing = T)
```

```{r}
avg <- sort(tapply(df$rent, df$region, mean), decreasing = T)
barplot(avg[1:8], xlab = '城区', ylab = '租金（元/月）', col = '#FFFF00', main = '不同城区降序平均租金')
```

北京各区平均月租金最高的是西城区，达到了3784.792元，最低的房山区月租金为1751.257元。通过上图可将北京不同城区合租房月租金进行分组：西城区独一组；海淀，朝阳，东城为第二组；石景山，丰台，昌平为第三组。组内租金相近，组间租金呈现阶梯式下降趋势。推测这可能与地理位置有关，在同一环线上的区租金相仿，更靠近内环的区租金更高。

## 月租金-城区 分组箱线图
```{r}
ggplot(df, aes(x=reorder(region, -rent, mean), y=rent)) + 
  geom_boxplot(fill = '#FFFF00') + labs(title='月租金-城区 分组箱线图',x='城区', y = '租金(元/月)')
```

这里我们同样按照均值进行对箱线图排序，方便我们的观察：

通过箱线图我们可以更明显地看出不同城区平均月租金呈现按组别变化的趋势，更进一步，我们可以看出朝阳，海淀和西城月租金分布较广，而其余城区则相对分布更加集中。

值得注意的是，朝阳区存在较多离群值，很有可能是在国贸和望京周边上班的人偏向租离单位更近的房子，自然价格就会更高；而相对外围的丰台，昌平，通州，大兴等地存在离群值的原因就可能有所不同，更有可能是用于休闲聚会的民宿。

## 以月租金作为因变量，其余变量为自变量建立线性回归模型并分析
```{r}
# 租赁房间变量以“次卧”作为基准组
df$room <- factor(df$room, levels = c("次卧", "主卧"))
# 所在楼层分组变量以“低楼层”作为基准组
df$floor_grp <- factor(df$floor_grp, levels = c("低楼层", "中楼层", "高楼层"))
# 邻近地铁变量以“否”作为基准组
df$subway <- factor(df$subway, levels = c("否", "是"))
# 城区变量以“石景山”作为基准组
df$region <- factor(df$region, levels = c("石景山", "房山", "顺义", "大兴", "通州", "昌平", "丰台", "东城", "朝阳", "海淀", "西城"))
# 供暖方式变量以“自采暖”作为基准组
df$heating <- factor(df$heating, levels = c("自采暖", "集中供暖"))
lm1 <- lm(formula = rent ~ ., data = df)
summary(lm1)
```

与上课类似，我们绘制表格整理得到的结果：

|变量   |回归系数   |p值    |备注   |
|:---:    |:---:    |:---:    |:---:    |
|截距项   |1593.224    |<2e-16    |   |
|卧室数   |-90.552   |<2e-16    |   |
|客厅数   |-168.019    |0.019    |   |
|卫生间数   |182.108   |3.05e-05   |   |
|房间面积   |76.692    |<2e-16   |   |
|房间类型：主卧   |0.084   |0.996    |基准组：次卧   |
|所在楼层：中楼层<br>所在楼层：高楼层   |-55.596<br>-24.985    |0.000281<br>0.117   |基准组：低楼层   |
|邻近地铁：是   |280.444    |<2e-16   |基准组：否   |
|所在城区：房山<br>所在城区：顺义<br>所在城区：大兴<br>所在城区：通州<br>所在城区：昌平<br>所在城区：丰台<br>所在城区：东城<br>所在城区：朝阳<br>所在城区：海淀<br>所在城区：西城    |-811.821<br>-450.959<br>-421.982<br>-373.006<br>57.200<br>177.597<br>565.017<br>631.695<br>878.863<br>938.862    |<2e-16<br><2e-16<br><2e-16<br><2e-16<br>0.093<br>0.000677<br><2e-16<br><2e-16<br><2e-16<br><2e-16   |<br><br><br><br><br>基准组：石景山|
|供暖方式：集中供暖   |155.791    |<2e-16   |基准组：自采暖   |
|F检验    |p值<2.2e-16   |Adjusted $R^2$ |0.6453   |
| | | | | 

控制其余因素不变的情况下，可以初步得到如下结论：

  $\cdot$每增加一间卧室，月租金下降90.552元；
  
  $\cdot$每增加一间客厅，月租金下降168.019元；
  
  $\cdot$每增加一间卫生间，月租金上升182.108元；
  
  $\cdot$房屋面积每增加一平方米，月租金上升76.692元；
  
  $\cdot$主卧租金高于次卧；
  
  $\cdot$所在楼层低楼层的租金最高，高楼层次之，中楼层租金最低；
  
  $\cdot$邻近地铁租金更高；
  
  $\cdot$石景山的房屋月租金高于房山，顺义，大兴，通州，低于昌平，丰台，东城，朝阳，海淀，西城；
  
  $\cdot$集中供暖租金要比自采暖更高。
  
总结一下：

（1）房屋面积越大，房屋条件越好（卫生间多，临近地铁，自采暖，地理位置），月租金越高；
（2）卧室和客厅稍有反常，推测是合租人数变多了导致月租金下降；
（3）主卧与次卧，低楼层与高楼层，客厅数，所在地区昌平区这几组变量相比其余变量并不显著。

## BIC变量选择
```{r results="hide"}
# 做对数变换即从AIC变成了BIC
lm2 <- step(lm1, direction = 'both', k = log(dim(df)[1]))
```

```{r}
summary(lm2)
```


同样绘制表格整理结果如下：

|变量   |回归系数   |p值    |备注   |
|:---:    |:---:    |:---:    |:---:    |
|截距项   |1440.449    |<2e-16    |   |
|卧室数   |-91.457  |<2e-16    |   |
|卫生间数   |141.751   |0.000477   |   |
|房间面积   |76.527    |<2e-16   |   |
|邻近地铁：是   |281.206    |<2e-16   |基准组：否   |
|所在城区：房山<br>所在城区：顺义<br>所在城区：大兴<br>所在城区：通州<br>所在城区：昌平<br>所在城区：丰台<br>所在城区：东城<br>所在城区：朝阳<br>所在城区：海淀<br>所在城区：西城    |-808.478<br>-456.412<br>-418.866<br>-372.159<br>58.700<br>119.461<br>565.767<br>634.860<br>880.960<br>935.072    |<2e-16<br><2e-16<br><2e-16<br><2e-16<br>0.0853<br>0.000561<br><2e-16<br><2e-16<br><2e-16<br><2e-16   |<br><br><br><br><br>基准组：石景山|
|供暖方式：集中供暖   |154.970    |<2e-16   |基准组：自采暖   |
|F检验    |p值<2.2e-16   |Adjusted $R^2$ |0.6443   |
|   |   |   |   |

可以看出经过BIC筛选后，剩余变量的显著性水平都比较高（昌平区夹在哑变量里，只能手动剔除），与上题分析结果相符，显著性水平比较低的客厅数、主卧次卧、楼层高低三个变量均被删除。


## 五折交叉验证
```{r warning=FALSE,fig.show="hide"}
# 使用DAAG包实现五折交叉验证,这里隐藏不必要的输出
cvlm2 = cv.lm(data = df, lm2, m = 5, printit = F, seed = 1234)

```
```{r}
attr(cvlm2, 'ms')
```
由五折交叉验证的结果，我们可以看出线性模型的拟合结果较差，为改善这一问题，我们进行模型诊断：

```{r}
par(mfrow = c(2,2))
plot(lm2,which=c(1:4))
```

根据模型诊断图我们发现模型拟合效果欠佳，异方差性较为明显，同时尾部正态性不佳，有改进空间，故使用对数线性模型进行改进：
```{r warning=FALSE,,results="hide",fig.show="hide"}
# 构建对数线性回归模型
lm3 <- lm(formula = log(rent)~ .,data = df)
# 同样使用BIC准则进行筛选
lm4 <- step(lm3, direction = 'both', k = log(dim(df)[1]))
# 五折交叉验证
cvlm4 = cv.lm(data = df, lm4, m = 5, printit = F, seed = 1234)
```
```{r}
attr(cvlm4, 'ms')
```

由五折交叉验证结果我们发现对数线性模型的拟合程度要远好于线性模型。

```{r}
par(mfrow = c(2,2))
plot(lm4,which=c(1:4))
```

同样从模型诊断图上来看，建立对数线性模型后，异方差和无正态性的情况都得到了较好的改善。这也同时说明五折交叉验证是帮助我们判断模型优劣的有力手段。
